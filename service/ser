for await (const row of rowStream) {

  // 1️⃣ FULL row from Excel (ALL columns)
  const fullRowData = { ...row };

  // 2️⃣ Mapped row (ONLY required headers for DB)
  const mappedRowData = {};
  const remarks = [];

  REQUIRED_HEADERS.forEach(h => {
    const value = fullRowData[h.originalHeader];

    if (value === null || value === undefined || value === '') {
      remarks.push(`${h.mappedHeader} is missing`);
    }

    mappedRowData[h.mappedHeader] = value ?? null;
  });

  // 3️⃣ Add remarks to FULL row (for processed Excel)
  fullRowData.remarks = remarks.join(', ');

  // 4️⃣ DB insert → ONLY mapped headers (NO CHANGE)
  dbBuffer.push([
    ...REQUIRED_HEADERS.map(h => mappedRowData[h.mappedHeader]),
    fullRowData.remarks
  ]);

  if (dbBuffer.length >= BATCH_SIZE) {
    await pool.query(sql, [dbBuffer]);
    dbBuffer = [];
  }

  // 5️⃣ Processed Excel / return → ALL columns
  processedData.push(fullRowData);
}

// Flush remaining DB rows
if (dbBuffer.length > 0) {
  await pool.query(sql, [dbBuffer]);
}

return {
  processedData,
  success: true,
  count: processedData.length
};
